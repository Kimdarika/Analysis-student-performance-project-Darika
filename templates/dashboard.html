<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏠 Dashboard | Student Analyzer (Full Screen)</title>
    <link rel="stylesheet" href="/static/css/footer.css">
    <link rel="stylesheet" href="/static/js/footer.js">
    <link rel="stylesheet" href="/static/css/navbar.css">
    <link rel="stylesheet" href="/static/js/navbar.js">
    <link rel="stylesheet" href="/static/css/ex.css">
    <link rel="stylesheet" href="/static/js/ex.js">
    <link rel="stylesheet" href="/static/css/dashboard-1.css">
    <link rel="stylesheet" href="/static/js/dashboard-1.js">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid px-5"> 
            <a class="navbar-brand fw-bold" href="index.html">Student Analyzer</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="/dashboard">🏠 Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/student-profile">👩‍🎓 Student Management</a></li>
                    <li class="nav-item"><a class="nav-link" href="/subject-analysis">📘 Subject Analysis</a></li>
                    <li class="nav-item"><a class="nav-link" href="/comparison">📈 Comparison</a></li>
                    <li class="nav-item"><a class="nav-link" href="/prediction">🧮 Prediction</a></li>
                    <li class="nav-item"><a class="nav-link" href="/reports">📊 Reports</a></li>
                    <li class="nav-item"><a class="nav-link" href="/teacher-insights">🧑‍🏫 Teacher Insights</a></li>
                    <li class="nav-item"><a class="nav-link" href="/trends">🗓️ Trend</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid mt-4 flex-grow-1 px-5"> 
        <h1 class="mb-4 text-primary">📊 Student Performance Overview</h1>
        
        <div class="row g-4 mb-5">
            <div class="col-xl-3 col-md-6">
                <div class="card card-shadow h-100 border-start border-primary border-5">
                    <div class="card-body">
                        <p class="card-text text-muted mb-1">Total Students</p>
                        <h2 class="card-title text-primary fw-bold">25</h2> </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card card-shadow h-100 border-start border-success border-5">
                    <div class="card-body">
                        <p class="card-text text-muted mb-1">Overall Avg. Score</p>
                        <h2 class="card-title text-success fw-bold" id="overallAvgScore">83.5%</h2>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card card-shadow h-100 border-start border-warning border-5">
                    <div class="card-body">
                        <p class="card-text text-muted mb-1">Top Performer</p>
                        <h5 class="card-title text-warning fw-bold">Alex Johnson</h5> <small class="text-muted">(96.2% Score)</small> </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card card-shadow h-100 border-start border-info border-5">
                    <div class="card-body">
                        <p class="card-text text-muted mb-1">Overall Pass Rate</p>
                        <h2 class="card-title text-info fw-bold" id="overallPassRate">94.2%</h2> </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-lg-6">
                <div class="card card-shadow h-100">
                    <div class="card-header bg-light text-primary fw-bold">
                        📘 Student Scores by Subject
                    </div>
                    <div class="card-body chart-container">
                        <canvas id="subjectChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card card-shadow h-100">
                    <div class="card-header bg-light text-success fw-bold">
                        📈 Grade Distribution (Cohort)
                    </div>
                    <div class="card-body chart-container">
                        <canvas id="gradeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="row g-4 mb-5">
            <div class="col-12">
                <div class="card card-shadow performance-table-card">
                    <div class="card-header bg-dark text-white fw-bold">
                        🗓️ Subject Performance Trend: Term 1 vs. Term 2
                    </div>
                    <div class="card-body">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Subject</th>
                                    <th class="text-center">Avg. Score T1 (%)</th>
                                    <th class="text-center">Avg. Score T2 (%)</th>
                                    <th class="text-center total-avg-score">Overall Avg. (%)</th>
                                    <th class="text-center">Change (T2-T1)</th>
                                    <th class="text-center">Overall Status</th>
                                </tr>
                            </thead>
                            <tbody id="performanceTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            Chart.register(ChartDataLabels);

            // Mock Data Structure Updated for Two Terms
            const MOCK_STUDENT_DATA = {
                // The courses array represents the unique subjects across both terms, 
                // containing scores for T1 and T2 (or null if not taken)
                courses: [
                    { name: "BCU", scoreT1: 91.0, scoreT2: null }, 
                    { name: "English for IT", scoreT1: 89.2, scoreT2: 92.5 },
                    { name: "General English", scoreT1: 76.5, scoreT2: 81.0 },
                    { name: "Logic", scoreT1: 92.1, scoreT2: null },
                    { name: "Programming Logic (PL)", scoreT1: 72.0, scoreT2: 78.8 },
                    { name: "Design", scoreT1: 80.4, scoreT2: null },
                    { name: "Algorithm", scoreT1: null, scoreT2: 95.8 },
                    { name: "Web Design", scoreT1: null, scoreT2: 85.0 }, 
                ]
            };
            
            // --- Global Data Calculation ---
            const ALL_SCORES = MOCK_STUDENT_DATA.courses
                .flatMap(c => [c.scoreT1, c.scoreT2])
                .filter(score => score !== null);

            const OVERALL_AVG = ALL_SCORES.length > 0 
                ? ALL_SCORES.reduce((a, b) => a + b, 0) / ALL_SCORES.length 
                : 0;

            document.getElementById('overallAvgScore').textContent = OVERALL_AVG.toFixed(1) + '%';
            
            const DYNAMIC_COURSE_LABELS = MOCK_STUDENT_DATA.courses.map(c => c.name);
            // Use T2 score if available, otherwise T1 score for the initial bar chart visualization
            const DYNAMIC_COURSE_SCORES = MOCK_STUDENT_DATA.courses.map(c => c.scoreT2 || c.scoreT1);

            // --- Utility Function to Get Score Class ---
            function getScoreClass(score) {
                if (score >= 90) return 'score-excellent';
                if (score >= 80) return 'score-good';
                if (score >= 70) return 'score-average';
                return 'score-poor';
            }

            // --- MODIFIED FUNCTION: Populates the Subject Performance Table ---
            function populatePerformanceTable(courses) {
                const tableBody = document.getElementById('performanceTableBody');
                tableBody.innerHTML = ''; 
                
                courses.forEach(course => {
                    const t1 = course.scoreT1;
                    const t2 = course.scoreT2;
                    
                    let overallAvg = null;
                    let change = null;
                    
                    const count = (t1 !== null) + (t2 !== null);
                    if (count > 0) {
                        overallAvg = ((t1 || 0) + (t2 || 0)) / count;
                    }

                    if (t1 !== null && t2 !== null) {
                        change = t2 - t1;
                    }

                    let statusText, statusClass;

                    if (overallAvg !== null) {
                        if (overallAvg >= 90) {
                            statusText = 'High Excellence';
                            statusClass = 'badge bg-primary';
                        } else if (overallAvg >= 80) {
                            statusText = 'Strong Performance';
                            statusClass = 'badge bg-success';
                        } else if (overallAvg >= 70) {
                            statusText = 'Steady Progress';
                            statusClass = 'badge bg-warning text-dark';
                        } else {
                            statusText = 'Critical Focus';
                            statusClass = 'badge bg-danger';
                        }
                    } else {
                         statusText = 'Single Term';
                         statusClass = 'badge bg-secondary';
                    }

                    const t1Display = t1 !== null ? `<span class="${getScoreClass(t1)}">${t1.toFixed(1)}</span>` : 'N/A';
                    const t2Display = t2 !== null ? `<span class="${getScoreClass(t2)}">${t2.toFixed(1)}</span>` : 'N/A';
                    const overallAvgDisplay = overallAvg !== null ? overallAvg.toFixed(1) : 'N/A';

                    let changeDisplay = 'N/A';
                    if (change !== null) {
                        const icon = change > 0 ? '⬆️' : (change < 0 ? '⬇️' : '➖');
                        const colorClass = change > 0 ? 'text-success' : (change < 0 ? 'text-danger' : 'text-muted');
                        changeDisplay = `<span class="${colorClass} fw-bold">${icon} ${Math.abs(change).toFixed(1)}</span>`;
                    }
                    
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${course.name}</td>
                        <td class="text-center">${t1Display}</td>
                        <td class="text-center">${t2Display}</td>
                        <td class="text-center total-avg-score">${overallAvgDisplay}</td>
                        <td class="text-center">${changeDisplay}</td>
                        <td class="text-center"><span class="${statusClass} rounded-pill px-3">${statusText}</span></td>
                    `;
                });
            }

            // --- Charting Functions ---
            const getScoreColor = (value) => {
                const hue = Math.max(0, Math.min(120, (value / 100) * 120));
                return `hsl(${hue}, 70%, 50%)`;
            };

            const backgroundColors = DYNAMIC_COURSE_SCORES.map(getScoreColor);

            // --- 1. Subject Scores Chart (Shows latest known score T2 or T1) ---
            const subjectCtx = document.getElementById('subjectChart').getContext('2d');
            new Chart(subjectCtx, {
                type: 'bar',
                data: {
                    labels: DYNAMIC_COURSE_LABELS,
                    datasets: [{
                        label: 'Latest Score (%)',
                        data: DYNAMIC_COURSE_SCORES.map(s => s.toFixed(1)),
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => value + '%',
                            color: '#495057', 
                            font: { weight: 'bold' }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100 },
                    }
                }
            });

            // --- 2. Grade Distribution Chart (Uses existing data updated for 25 students) ---
            const TOTAL_STUDENTS = 25; // Define the total for calculation
            const gradeDistributionData = {
                labels: ['A+ (90-100)', 'A (80-89)', 'B (70-79)', 'C/F (<70)'],
                // UPDATED: Counts adjusted to sum to 25 (e.g., 5 + 10 + 7 + 3 = 25)
                counts: [5, 10, 7, 3], 
                colors: ['#0d6efd', '#198754', '#ffc107', '#dc3545']
            };
            const studentsPassed = gradeDistributionData.counts[0] + gradeDistributionData.counts[1] + gradeDistributionData.counts[2];
            const passRate = (studentsPassed / TOTAL_STUDENTS) * 100;

            // UPDATED: Recalculate and update Overall Pass Rate
            document.getElementById('overallPassRate').textContent = passRate.toFixed(1) + '%'; 
            
            const gradeCtx = document.getElementById('gradeChart').getContext('2d');
            new Chart(gradeCtx, {
                type: 'doughnut',
                data: {
                    labels: gradeDistributionData.labels,
                    datasets: [{
                        data: gradeDistributionData.counts,
                        backgroundColor: gradeDistributionData.colors,
                        hoverOffset: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        datalabels: {
                            color: '#fff',
                            formatter: (value, context) => {
                                // Display count (value) and percentage
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = (value / total * 100).toFixed(1);
                                return value + ' (' + percentage + '%)';
                            },
                            font: { weight: 'bold', size: 12 }
                        }
                    }
                }
            });

            // Call the function to populate the dashboard table
            populatePerformanceTable(MOCK_STUDENT_DATA.courses);
            
        });
    </script>
    <footer>
        <p>© 2025 Student Analyzer. All Rights Reserved.</p>
        <p>
            <a href="index.html">Home</a> | 
            <a href="reports.html">Reports</a> | 
            <a href="contact.html">Contact</a>
        </p>
        <p class="social-icons">
            <a href="#" title="Facebook">📘</a>
            <a href="#" title="Twitter">🐦</a>
            <a href="#" title="LinkedIn">💼</a>
        </p>
        <p>Made with ❤️ by the Student Analyzer Team</p>
    </footer>
</body>
</html>