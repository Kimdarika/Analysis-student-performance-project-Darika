<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Student Performance Profile</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f9; padding: 20px; }
        .container { max-width: 900px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #1e3c72; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #e0e6ed; padding-bottom: 5px; margin-top: 25px; color: #2a6f8a; font-size: 1.5em; }
        
        /* Tab Styles */
        .tab-buttons { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-button { background-color: #f1f1f1; border: none; outline: none; cursor: pointer; padding: 10px 20px; transition: 0.3s; font-size: 16px; border-radius: 8px 8px 0 0; margin-right: 5px; }
        .tab-button:hover { background-color: #ddd; }
        .tab-button.active { background-color: #1e3c72; color: white; }
        .tab-content { padding: 6px 12px; border-top: none; }

        /* Input Table Styles */
        #scoreTable th, #scoreTable td { padding: 8px; text-align: center; border: 1px solid #ddd; }
        #scoreTable th { background-color: #1e3c72; color: white; font-weight: 600; }
        #scoreTable input[type="number"] { width: 70px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        
        /* Study Hours Row */
        .study-hours-row td { background-color: #e6f7ff; font-weight: 600; padding: 10px; border: none !important; }

        /* Button */
        #runAnalysis { padding: 12px 25px; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 15px; display: block; width: 100%; transition: background-color 0.3s; }
        #runAnalysis:hover { background-color: #218838; }

        /* Analysis Metrics & Cards */
        .analysis-box { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
        .metric-card { flex-grow: 1; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .metric-card h3 { font-size: 1em; color: #555; margin-bottom: 5px; }
        .metric-card p { font-size: 1.8em; font-weight: bold; margin: 0; }
        .alert-card { background-color: #ffe0e0; border: 2px solid #e74c3c; color: #e74c3c; }
        .alert-card.urgent { background-color: #f8d7da; border-color: #dc3545; color: #dc3545; }
        .alert-card.urgent p { color: #dc3545; }
        
        /* Analysis Table */
        #analysisTable { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        #analysisTable th, #analysisTable td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        #analysisTable th { background-color: #2a6f8a; color: white; }
        .growth-positive { color: #0f5132; background-color: #d1e7dd; font-weight: bold; }
        .growth-negative { color: #842029; background-color: #f8d7da; font-weight: bold; }
        .growth-stable { color: #664d03; background-color: #fff3cd; }
        
        /* Digraph Insights */
        #digraphInsights { margin-top: 15px; padding: 15px; border: 1px solid #c7d0d9; border-radius: 8px; background-color: #f9fbfd; }
        #digraphInsights p { margin: 5px 0; padding-left: 15px; border-left: 3px solid #2a6f8a; font-size: 0.95em; }
        #digraphInsights .insight-red { color: #dc3545; font-weight: 600; border-left-color: #dc3545; }
        .insight-green { color: #28a745; font-weight: 600; border-left-color: #28a745; }

        /* Radar Chart Wrapper */
        #chart-wrapper { width: 70%; margin: 20px auto; padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Advanced Student Performance Profile</h1>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab(event, 'dataEntry')">Data Entry & Scores</button>
            <button class="tab-button" onclick="openTab(event, 'analysis')">Analysis & Digraph</button>
        </div>

        <div id="dataEntry" class="tab-content">
            <h2>Term-by-Term Score Input (Max 100)</h2>
            <table id="scoreTable" style="width: 100%;">
                <thead>
                    <tr>
                        <th rowspan="2">Subject</th>
                        <th colspan="3">Term 1</th>
                        <th colspan="3">Term 2</th>
                    </tr>
                    <tr>
                        <th>Score</th>
                        <th>Attendance (%)</th>
                        <th>Completion (%)</th>
                        <th>Score</th>
                        <th>Attendance (%)</th>
                        <th>Completion (%)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
                <tfoot>
                    <tr class="study-hours-row">
                        <td colspan="2">Weekly Study Hours (T1):</td>
                        <td colspan="2"><input type="number" id="studyHoursT1" value="10" min="1" style="width: 100%;"></td>
                        <td colspan="2">Weekly Study Hours (T2):</td>
                        <td colspan="1"><input type="number" id="studyHoursT2" value="12" min="1" style="width: 100%;"></td>
                    </tr>
                </tfoot>
            </table>

            <button id="runAnalysis" onclick="calculatePerformance()">Run Advanced Analysis</button>
        </div>

        <div id="analysis" class="tab-content" style="display:none;">
            <h2>ðŸš¨ Predictive Alerts & Core Metrics</h2>

            <div class="analysis-box">
                <div class="metric-card alert-card">
                    <h3>High-Risk Alerts (T1)</h3>
                    <p id="riskAlerts">None Detected</p>
                </div>
                <div class="metric-card">
                    <h3>Overall Growth ($\Delta$ Avg)</h3>
                    <p id="overallGrowth">-</p>
                </div>
                <div class="metric-card">
                    <h3>Avg. Pacing ($\beta$)</h3>
                    <p id="avgPacing">-</p>
                </div>
            </div>

            <h2>ðŸ“Š Progression Radar Comparison (T1 vs T2 Scores)</h2>
            <div id="chart-wrapper" style="width: 70%; margin: 20px auto;">
                <canvas id="digraphRadarChart"></canvas>
            </div>

            <h2>ðŸ“ˆ Subject Performance Breakdown</h2>
            <table id="analysisTable">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>T1 Score</th>
                        <th>T2 Score</th>
                        <th>Change ($\Delta$)</th>
                        <th>T2 Pacing ($\beta$)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>

            <h2>ðŸ”— Performance Digraph Insights (Progression & Correlation)</h2>
            <div id="digraphInsights">
                <p>Input scores and run analysis to see insights on prerequisite knowledge and skill continuity.</p>
            </div>
        </div>

    </div>

    <script>
        // --- 1. Data Definition ---
        const subjectData = [
            { name: "BCU", term1: true, term2: false },
            { name: "Logic", term1: true, term2: false },
            { name: "Design", term1: true, term2: false },
            { name: "English for IT", term1: true, term2: true },
            { name: "General English", term1: true, term2: true },
            { name: "PL", term1: true, term2: true },
            { name: "Algorithm", term1: false, term2: true },
            { name: "Web Design", term1: false, term2: true }
        ];

        // Digraph relationships (Prerequisite -> Dependent)
        const digraphRelations = {
            "Logic": "Algorithm",
            "PL": "PL", // Continuity
            "Design": "Web Design",
            "English for IT": "English for IT",
            "General English": "General English"
        };

        let studentScores = {}; 
        let chartInstance = null; 


        // --- 2. Initial Setup: Populate Data Entry Table ---
        function populateTable() {
            const tbody = document.getElementById('scoreTable').querySelector('tbody');
            if (!tbody) return; 
            tbody.innerHTML = ''; 

            subjectData.forEach(subject => {
                const row = tbody.insertRow();
                row.insertCell().textContent = subject.name;
                
                // Helper function for input cell
                const createInputCell = (term, type, defaultValue) => {
                    const cell = row.insertCell();
                    if (subject[term]) {
                        const max = 100;
                        const min = 0;
                        // For demonstration, fill with sample data
                        let sampleValue = 80;
                        if (subject.name === 'Logic' && term === 'term1' && type === 'score') sampleValue = 55;
                        if (subject.name === 'Algorithm' && term === 'term2' && type === 'score') sampleValue = 75;
                        if (subject.name === 'PL' && term === 'term1' && type === 'score') sampleValue = 90;
                        if (subject.name === 'PL' && term === 'term2' && type === 'score') sampleValue = 85;

                        cell.innerHTML = `<input type="number" id="${subject.name}-${term}-${type}" min="${min}" max="${max}" value="${sampleValue}">`;
                    } else {
                        cell.textContent = "N/A";
                    }
                };

                // Term 1 Inputs (Score, Attendance, Completion)
                createInputCell('term1', 'score'); 
                createInputCell('term1', 'attendance');
                createInputCell('term1', 'completion');

                // Term 2 Inputs (Score, Attendance, Completion)
                createInputCell('term2', 'score');
                createInputCell('term2', 'attendance');
                createInputCell('term2', 'completion');
            });
        }

        // --- 3. Core Calculation Logic ---
        function calculatePerformance() {
            studentScores = {};
            let totalChange = 0;
            let totalPacing = 0;
            let subjectsWithChange = 0;
            let subjectsWithPacing = 0;
            
            const studyHoursT1 = parseFloat(document.getElementById('studyHoursT1').value) || 1;
            const studyHoursT2 = parseFloat(document.getElementById('studyHoursT2').value) || 1;

            let errorFound = false;

            // 1. Gather Scores and Calculate Metrics
            subjectData.forEach(subject => {
                const getVal = (term, type) => {
                    const el = document.getElementById(`${subject.name}-${term}-${type}`);
                    const value = el ? parseFloat(el.value) : null;
                    if (el && value !== null && (value < 0 || value > 100)) {
                        alert(`Invalid input for ${subject.name} in ${term}. Must be between 0 and 100.`);
                        errorFound = true;
                        return NaN;
                    }
                    return value;
                };

                const t1Score = getVal('term1', 'score');
                const t2Score = getVal('term2', 'score');
                const t1Att = getVal('term1', 'attendance');
                const t2Att = getVal('term2', 'attendance');
                
                if (errorFound) return;

                studentScores[subject.name] = { t1: t1Score, t2: t2Score, t1Att, t2Att };

                // 2. Calculate Term-to-Term Change
                if (subject.term1 && subject.term2 && t1Score !== null && t2Score !== null) {
                    const change = t2Score - t1Score;
                    studentScores[subject.name].change = change;
                    
                    totalChange += change;
                    subjectsWithChange++;
                }

                // 3. Calculate Pacing Metric (Beta = Score / Study Hours) for Term 2
                if (t2Score !== null && studyHoursT2 > 0) {
                    const pacing = t2Score / studyHoursT2; 
                    studentScores[subject.name].pacing = pacing;
                    totalPacing += pacing;
                    subjectsWithPacing++;
                }

                // 4. Predictive Alert/Risk Check
                if (t1Score !== null && t1Score < 60 && t1Att !== null && t1Att < 80) {
                    studentScores[subject.name].highRisk = true;
                }
            });

            if (errorFound) return;

            // 5. Update Summary Metrics
            const overallAvgChange = subjectsWithChange > 0 ? (totalChange / subjectsWithChange).toFixed(1) : 0;
            const overallAvgPacing = subjectsWithPacing > 0 ? (totalPacing / subjectsWithPacing).toFixed(2) : 0;
            
            document.getElementById('overallGrowth').textContent = `${overallAvgChange > 0 ? '+' : ''}${overallAvgChange}%`;
            document.getElementById('avgPacing').textContent = `${overallAvgPacing} pts/hr`;
            
            // 6. Update Predictive Alert Card
            const riskSubjects = Object.keys(studentScores).filter(name => studentScores[name].highRisk);
            const riskAlertElement = document.getElementById('riskAlerts');
            const alertCard = document.querySelector('.alert-card');

            if (riskSubjects.length > 0) {
                riskAlertElement.textContent = `${riskSubjects.length} Subject(s): ${riskSubjects.join(', ')}`;
                alertCard.classList.add('urgent');
            } else {
                riskAlertElement.textContent = `None Detected`;
                alertCard.classList.remove('urgent');
            }

            // 7. Update Analysis Table, Digraph Text, and Chart
            updateAnalysisTable();
            generateDigraphInsights();
            renderDigraphChart(); 

            openTab(null, 'analysis'); // Switch to analysis tab
        }

        // --- 4. Update Analysis Table ---
        function updateAnalysisTable() {
            const tbody = document.getElementById('analysisTable').querySelector('tbody');
            tbody.innerHTML = '';

            Object.keys(studentScores).forEach(name => {
                const data = studentScores[name];
                
                if (data.t1 !== null || data.t2 !== null) {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = name;
                    row.insertCell().textContent = data.t1 !== null ? data.t1.toFixed(0) : "N/A";
                    row.insertCell().textContent = data.t2 !== null ? data.t2.toFixed(0) : "N/A";

                    const changeCell = row.insertCell();
                    if (data.change !== undefined) {
                        const changeValue = data.change.toFixed(1);
                        changeCell.textContent = (data.change > 0 ? '+' : '') + changeValue + '%';
                        changeCell.className = data.change > 0 ? 'growth-positive' : (data.change < 0 ? 'growth-negative' : 'growth-stable');
                    } else {
                        changeCell.textContent = "N/A";
                    }
                    
                    row.insertCell().textContent = data.pacing !== undefined ? data.pacing.toFixed(2) : "N/A";

                    const statusCell = row.insertCell();
                    if (data.change !== undefined) {
                        if (data.change > 5 && data.t2 >= 70) {
                            statusCell.textContent = 'Excellent Growth';
                            statusCell.classList.add('growth-positive');
                        } else if (data.change < -5 || data.t2 < 60) {
                            statusCell.textContent = 'Needs Focus (Decline/Low)';
                            statusCell.classList.add('growth-negative');
                        } else {
                            statusCell.textContent = 'Stable Progress';
                        }
                    } else if (data.t2 !== null && data.t2 < 60) {
                        statusCell.textContent = 'Low Score in Term 2';
                        statusCell.classList.add('growth-negative');
                    } else {
                        statusCell.textContent = 'Completed/New Subject';
                    }
                }
            });
        }

        // --- 5. Digraph (Progression) Analysis Text ---
        function generateDigraphInsights() {
            let insights = [];

            for (const [prereq, dependent] of Object.entries(digraphRelations)) {
                const prereqData = studentScores[prereq];
                const dependentData = studentScores[dependent];
                
                const prereqScore = prereqData?.t1;
                const dependentScore = dependentData?.t2;
                const dependentChange = dependentData?.change;
                
                if (prereqScore !== null && dependentScore !== null) {
                    
                    let insightText = '';
                    let insightClass = '';

                    if (prereq === dependent) {
                        // Continuity subjects 
                        if (dependentChange > 5) {
                            insightText = `**${prereq} Continuity:** Strong progress (+${dependentChange.toFixed(1)}%) shows successful retention.`;
                            insightClass = 'insight-green';
                        } else if (dependentChange < -5) {
                            insightText = `**${prereq} Continuity:** Significant decline (${dependentChange.toFixed(1)}%) suggests issues in skill retention.`;
                            insightClass = 'insight-red';
                        }
                    } else {
                        // Dependency subjects 
                        if (prereqScore < 60 && dependentScore < 60) {
                            insightText = `âŒ **Foundational Failure (${prereq} â†’ ${dependent}):** Critical knowledge gap carried over.`;
                            insightClass = 'insight-red';
                        } else if (prereqScore >= 70 && dependentScore < 60) {
                            insightText = `ðŸ§ **Application Gap (${prereq} â†’ ${dependent}):** Good prerequisite score but poor application (${dependentScore.toFixed(0)}%) in T2.`;
                            insightClass = '';
                        } else if (prereqScore < 60 && dependentScore >= 70) {
                            insightText = `ðŸ’¡ **Overcame Prerequisite (${prereq} â†’ ${dependent}):** Impressive jump! Low T1 score was overcome for a high T2 score.`;
                            insightClass = 'insight-green';
                        }
                    }
                    
                    if (insightText) {
                        insights.push(`<p class="${insightClass}">${insightText}</p>`);
                    }
                }
            }

            const insightsDiv = document.getElementById('digraphInsights');
            if (insights.length > 0) {
                insightsDiv.innerHTML = insights.join('');
            } else {
                insightsDiv.innerHTML = "<p>No significant progression trends identified, or necessary scores are missing.</p>";
            }
        }

        // --- 6. Chart Rendering Function (Visual Digraph) ---
        function renderDigraphChart() {
            // 1. Prepare Data for the Chart
            const labels = [];
            const t1Scores = [];
            const t2Scores = [];

            // Filter subjects that have T1 and T2 scores for a meaningful radar comparison
            subjectData.filter(s => s.term1 && s.term2).forEach(subject => {
                const data = studentScores[subject.name];
                // Only include subjects where scores were successfully input for BOTH terms
                if (data && data.t1 !== null && data.t2 !== null) { 
                    labels.push(subject.name);
                    t1Scores.push(data.t1);
                    t2Scores.push(data.t2);
                }
            });

            const ctx = document.getElementById('digraphRadarChart').getContext('2d');

            // Destroy existing chart if it exists to prevent overlap/memory leak
            if (chartInstance) {
                chartInstance.destroy();
            }

            // 2. Render the Radar Chart
            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Term 1 Score (Foundation)',
                            data: t1Scores,
                            backgroundColor: 'rgba(0, 123, 255, 0.2)', // Light Blue
                            borderColor: 'rgba(0, 123, 255, 1)',
                            pointBackgroundColor: 'rgba(0, 123, 255, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(0, 123, 255, 1)'
                        },
                        {
                            label: 'Term 2 Score (Application)',
                            data: t2Scores,
                            backgroundColor: 'rgba(40, 167, 69, 0.2)', // Light Green
                            borderColor: 'rgba(40, 167, 69, 1)',
                            pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(40, 167, 69, 1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            angleLines: { display: true },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            pointLabels: { font: { size: 12 } },
                            ticks: { backdropColor: 'rgba(255, 255, 255, 0.7)' }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });
        }


        // --- 7. Tab Switching Logic ---
        function openTab(evt, tabName) {
            const tabcontents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontents.length; i++) {
                tabcontents[i].style.display = "none";
            }

            const tablinks = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            if (evt) {
                evt.currentTarget.className += " active";
            } else {
                const targetButton = Array.from(tablinks).find(btn => btn.textContent.includes(tabName === 'dataEntry' ? 'Data Entry' : 'Analysis'));
                if (targetButton) {
                    targetButton.className += " active";
                }
            }
        }

        // --- 8. Initialization: CRITICAL FOR LOADING INPUT ROWS ---
        document.addEventListener('DOMContentLoaded', () => {
            populateTable(); 
            openTab(null, 'dataEntry');
        });
    </script>
    </body>
</html>